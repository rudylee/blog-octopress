
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Upload file in CakePHP using Media Plugin - blog.rudylee.com</title>
  <meta name="author" content="Rudy Lee">

  
  <meta name="description" content="There are many solutions to handle file upload in PHP, one of the common solutions is to create a custom action that will check the type of the file &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://rudylee.github.io/2010/06/03/upload-file-in-cakephp-using-media-plugin/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="blog.rudylee.com" type="application/atom+xml">
  <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <div id="logo">
  	<div id="logoLeft">{</div>
  	<div id="logoText">mob</div>
  	<div id="logoRight">}</div>
  	<div class="clear"></div>
  </div>
  <h1><a href="/">blog.rudylee.com</a></h1>
  
    <h2>keep it humble</h2>
  
  <div class="clear"></div>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:rudylee.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      
        <h1 class="entry-title">Upload File in CakePHP Using Media Plugin</h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2010-06-03T20:42:02+10:00" pubdate data-updated="true">Jun 3<span>rd</span>, 2010</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>There are many solutions to handle file upload in PHP, one of the common solutions is to create a custom action that will check the type of the file, size, validate whether the file name already exists or not, and the last thing is moving the file using move_uploaded_file(). However, it doesn&rsquo;t end when the files are in your server, after that you still need to write a function to delete the files, manipulate it if needed and so on.</p>

<p>I already tried several ways to handle upload file in CakePHP, from writing a private action in the app_controller and the last I write a component.</p>

<p>I can upload file, delete file, check the file type using my Upload Component, but I realize that there are many things missing in my component.</p>

<p>In searching for inspiration, I found CakePHP do have serveral plugins to handle File Upload and the features are beyond my component.</p>

<p>One of the plugin is <a href="http://github.com/davidpersson/media">Media Plugin</a> by Davidpersson.</p>

<p>Using the plugin is quite easy, but the wiki and the CakeFest slide is not updated with the new configuration ( I am using v1.3alpha ), so you need to jumped in to the core and trying to understand the new configuration.</p>

<p>Basically the plugin consist of several behaviours :</p>

<ul>
<li><p>Transfer</p></li>
<li><p>Polymorphic</p></li>
<li><p>Meta</p></li>
<li><p>Generator</p></li>
<li><p>Coupler</p></li>
</ul>


<p>But in this post I will just cover the Transfer,Coupler and Meta behaviour because I only understand these behaviours. So lets go to the implementation part, here is my CakePHP and Media Plugin version :</p>

<ol>
<li><p> CakePHP 1.3.0</p></li>
<li><p> Media Plugin 1.3 alpha</p></li>
</ol>


<p>First you must create a table that has a &lsquo;file&rsquo; field in it. Remember, the field must be named &lsquo;file&rsquo; or the plugin won&rsquo;t working. Here is the example with my application :</p>

<pre><code>CREATE TABLE IF NOT EXISTS `photos` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `title` varchar(255) NOT NULL,
  `file` varchar(255) NOT NULL,
  `dirname` varchar(255) NOT NULL,
  `basename` varchar(255) NOT NULL,
  `checksum` varchar(255) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=MyISAM  DEFAULT CHARSET=latin1 AUTO_INCREMENT=13 ;
</code></pre>

<p>The field that will be used by the plugin are file, dirname, basename, and checksum. But the three last fields is optional, so you can have it in your table or not (if you are using Coupler, and Meta behaviour you MUST add the there fields ). Next, bake the application ( I was using &lsquo;cake bake&rsquo; command ).</p>

<p>After that grab the Media Plugin from the github and put it in the plugins folder of your application. Next you will need to include the plugin to your application, open your bootstrap.php / core.php and add this line in it :</p>

<pre><code>require APP . 'plugins/media/config/core.php';
</code></pre>

<p>Then create the folder that will be used for storing the files. Go to your application folder in terminal and type this command ( ex: /var/www/sample ) :</p>

<pre><code>cake media init
</code></pre>

<p>The command will ask whether you want to create the directories or not, this is the print out of my terminal :</p>

<pre><code>rudy@rudy-laptop:~/www/dummy$ cake media init
---------------------------------------------------------------
Media Shell
---------------------------------------------------------------
Do you want to create missing media directories now?
[n] &gt; y
/dummy/webroot/media/                              [OK  ]
/dummy/webroot/media/static/                       [OK  ]
/dummy/webroot/media/static/aud                    [OK  ]
/dummy/webroot/media/static/css                    [OK  ]
/dummy/webroot/media/static/doc                    [OK  ]
/dummy/webroot/media/static/gen                    [OK  ]
/dummy/webroot/media/static/ico                    [OK  ]
/dummy/webroot/media/static/img                    [OK  ]
/dummy/webroot/media/static/js                     [OK  ]
/dummy/webroot/media/static/txt                    [OK  ]
/dummy/webroot/media/static/vid                    [OK  ]
/dummy/webroot/media/transfer/                     [OK  ]
/dummy/webroot/media/transfer/aud                  [OK  ]
/dummy/webroot/media/transfer/css                  [OK  ]
/dummy/webroot/media/transfer/doc                  [OK  ]
/dummy/webroot/media/transfer/gen                  [OK  ]
/dummy/webroot/media/transfer/ico                  [OK  ]
/dummy/webroot/media/transfer/img                  [OK  ]
/dummy/webroot/media/transfer/js                   [OK  ]
/dummy/webroot/media/transfer/txt                  [OK  ]
/dummy/webroot/media/transfer/vid                  [OK  ]
/dummy/webroot/media/filter/                       [OK  ]

/dummy/webroot/media/transfer/.htaccess is not in your webroot.
Remember to set the correct permissions on transfer and filter directory.
</code></pre>

<p>Change the permission of the folder so that the webserver can write in it :</p>

<pre><code>chown -R www-data webroot/media
</code></pre>

<p>Configure the &lsquo;Photo&rsquo; model like this :</p>

<pre><code>class Photo extends AppModel {
    var $name = 'Photo';
    var $displayField = 'title';
    var $actsAs = array('Media.Transfer','Media.Coupler','Media.Meta');
    var $validate = array(
        'file' =&gt; array(
            'mimeType' =&gt; array(
            'rule' =&gt; array('checkMimeType', false, array ( 'image/jpeg', 'image/png'))
        ),
        'size' =&gt; array(
            'rule' =&gt; array('checkSize' , '5M')
        )
    ));
}
</code></pre>

<p>As you can see, I added 3 behaviors ( Transfer, Coupler and Meta ). The transfer behavior is used for uploading, moving and validating the file. The coupler is for deleting the file ( it will automatically delete the file if you delete a record associated with it and also will automatically add the value in dirname and basename ), the last thing that it will do is adding the meta description to the table ( checksum ).</p>

<p>Edit the add.ctp and adding the &lsquo;type&rsquo; => &lsquo;file&rsquo; in the $this->Form->create and the $this->Form->input(&lsquo;file&rsquo;) so the form can handle file upload. In the controller you don&rsquo;t need to change anything because the behavior automatically handle the validation, the path and moving the file. this is my controller :</p>

<pre><code>Photo-&gt;recursive = 0;
        $this-&gt;set('photos', $this-&gt;paginate());
    }

    function view($id = null) {
        if (!$id) {
            $this-&gt;Session-&gt;setFlash(sprintf(__('Invalid %s', true), 'photo'));
            $this-&gt;redirect(array('action' =&gt; 'index'));
        }
        $this-&gt;set('photo', $this-&gt;Photo-&gt;read(null, $id));
    }

    function add() {
        if (!empty($this-&gt;data)) {
            $this-&gt;Photo-&gt;create();
            if ($this-&gt;Photo-&gt;saveAll($this-&gt;data)) {
                $this-&gt;Session-&gt;setFlash(sprintf(__('The %s has been saved', true), 'photo'));
                $this-&gt;redirect(array('action' =&gt; 'index'));
            } else {
                $this-&gt;Session-&gt;setFlash(sprintf(__('The %s could not be saved. Please, try again.', true), 'photo'));
            }
        }
    }

    function edit($id = null) {
        if (!$id &amp;&amp; empty($this-&gt;data)) {
            $this-&gt;Session-&gt;setFlash(sprintf(__('Invalid %s', true), 'photo'));
            $this-&gt;redirect(array('action' =&gt; 'index'));
        }
        if (!empty($this-&gt;data)) {
            if ($this-&gt;Photo-&gt;save($this-&gt;data)) {
                $this-&gt;Session-&gt;setFlash(sprintf(__('The %s has been saved', true), 'photo'));
                $this-&gt;redirect(array('action' =&gt; 'index'));
            } else {
                $this-&gt;Session-&gt;setFlash(sprintf(__('The %s could not be saved. Please, try again.', true), 'photo'));
            }
        }
        if (empty($this-&gt;data)) {
            $this-&gt;data = $this-&gt;Photo-&gt;read(null, $id);
        }
    }

    function delete($id = null) {
        if (!$id) {
            $this-&gt;Session-&gt;setFlash(sprintf(__('Invalid id for %s', true), 'photo'));
            $this-&gt;redirect(array('action'=&gt;'index'));
        }
        if ($this-&gt;Photo-&gt;delete($id)) {
            $this-&gt;Session-&gt;setFlash(sprintf(__('%s deleted', true), 'Photo'));
            $this-&gt;redirect(array('action'=&gt;'index'));
        }
        $this-&gt;Session-&gt;setFlash(sprintf(__('%s was not deleted', true), 'Photo'));
        $this-&gt;redirect(array('action' =&gt; 'index'));
    }
}
?&gt;
</code></pre>

<p>and this is my add view :</p>

<pre><code>Form-&gt;create('Photo',array('type' =&gt; 'file'));?&gt;
    Form-&gt;input('title');
        echo $this-&gt;Form-&gt;input('file',array('type' =&gt; 'file'));
    ?&gt;
Form-&gt;end(__('Submit', true));?&gt;
&lt;/div&gt;
</code></pre>

<p>Now you are ready to uploading files, deleting files, and validate them in the model ( for validation you can see the wiki in the github for complete validation ). That&rsquo;s all :D</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">admin</span></span>

      








  


<time datetime="2010-06-03T20:42:02+10:00" pubdate data-updated="true">Jun 3<span>rd</span>, 2010</time>
      

<span class="categories">
  
    <a class='category' href='/categories/cakephp/'>CakePHP</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://rudylee.github.io/2010/06/03/upload-file-in-cakephp-using-media-plugin/" data-via="" data-counturl="http://rudylee.github.io/2010/06/03/upload-file-in-cakephp-using-media-plugin/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left articlenav" href="/2010/06/02/maaf-karena-saya-unfollow-kamu/" title="Previous Post: Maaf karena saya unfollow kamu">&laquo; Maaf karena saya unfollow kamu</a>
      
      
        <a class="basic-alignment right articlenav" href="/2010/06/07/setting-up-nfs-di-ubuntu/" title="Next Post: Setting up NFS di Ubuntu">Setting up NFS di Ubuntu &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2013/05/27/playing-with-google-map-api/">Playing with Google Map API</a>
      </li>
    
      <li class="post">
        <a href="/2013/05/16/override-module-config-in-zend-framework-2/">Override module config in Zend Framework 2</a>
      </li>
    
      <li class="post">
        <a href="/2013/05/06/zend-framework-2-the-proper-way-to-set-application-path-in-javascript-object/">Zend Framework 2 : The proper way to set application path in Javascript Object</a>
      </li>
    
      <li class="post">
        <a href="/2013/03/30/my-review-after-two-months-using-vim/">My review after two months using VIM</a>
      </li>
    
      <li class="post">
        <a href="/2013/02/15/zend-framework-2-get-server-url-in-controller-without-using-serverurl/">Zend Framework 2 : get server URL in controller without using serverUrl()</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Rudy Lee -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'blogrudylee';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://rudylee.github.io/2010/06/03/upload-file-in-cakephp-using-media-plugin/';
        var disqus_url = 'http://rudylee.github.io/2010/06/03/upload-file-in-cakephp-using-media-plugin/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
